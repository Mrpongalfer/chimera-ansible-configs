# Default functional docker-compose.yml.j2 generated by Chimera v2.7 v1.3
# Deploys Prometheus container using variables defined in Ansible play vars.
# Note: Assumes docker_run_user/group variables define user with permissions for host volumes.

services: # Use services key (more standard than version key now)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    user: "{{ docker_run_user | default('root') }}" # Run container as specified user
    volumes:
      # Mount config file rendered by Ansible (read-only)
      - {{ prometheus_config_file_path }}:/etc/prometheus/prometheus.yml:ro
      # Mount data volume (ensure host path {{ prometheus_data_dir }} exists and has correct permissions for container user)
      - {{ prometheus_data_dir }}:/prometheus
    ports:
      # Use variable from play vars (site.yml) for host port, map to container port 9090
      - "{{ prometheus_port }}:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle' # Allows hot-reloading config via API post to /-/reload
    restart: unless-stopped
    # Add networks if needed
    # networks:
    #  - monitoring_network

# Define networks if needed
# networks:
#   monitoring_network:
#     external: true

