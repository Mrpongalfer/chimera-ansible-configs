# Default docker-compose.yml.j2 generated by Chimera v2.7 v1.1
# Deploys Prometheus container using variables defined in Ansible play vars.

version: '3.7' # Still useful for some tooling despite deprecation warning

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    # User mapping is important for volume permissions
    # user: "{{ docker_run_user | default('root') }}:{{ docker_run_group | default('root') }}" # Requires host user/group IDs
    volumes:
      # Mount config file rendered by Ansible (read-only)
      - {{ prometheus_config_file_path }}:/etc/prometheus/prometheus.yml:ro
      # Mount data volume (ensure host path {{ prometheus_data_dir }} exists and has permissions for container user)
      - {{ prometheus_data_dir }}:/prometheus
    ports:
      # Use variable for host port, map to container port 9090
      - "{{ prometheus_port | default(9091) }}:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle' # Allows hot-reloading config via API post to /-/reload
    restart: unless-stopped
    # Add networks if needed, e.g., to connect to Alertmanager
    # networks:
    #  - monitoring_network

# Define networks if needed
# networks:
#   monitoring_network:
#     external: true # Or define it here

