# Default functional prometheus.yml.j2 generated by Chimera v2.7
# Scrapes Prometheus itself and Node Exporters on server/client groups.
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    # Scrape Prometheus itself (inside Docker, uses internal port)
    static_configs:
      # Use localhost and the defined port (variable from site.yml play vars)
      - targets: ["localhost:{{ prometheus_port | default(9091) }}"]

  - job_name: "node_exporter"
    # Scrape node_exporter based on inventory groups
    static_configs:
      - targets:
{% set node_targets = [] %}
{% if 'server' in groups %}
{%   for host in groups['server'] %}
{%     set _ = node_targets.append( hostvars[host]['ansible_host'] | default(host) ~ ':' ~ (hostvars[host]['node_exporter_port'] | default(9100)) ) %}
{%   endfor %}
{% endif %}
{% if 'clients' in groups %}
{%   for host in groups['clients'] %}
{%     set _ = node_targets.append( hostvars[host]['ansible_host'] | default(host) ~ ':' ~ (hostvars[host]['node_exporter_port'] | default(9100)) ) %}
{%   endfor %}
{% endif %}
{{ node_targets | to_yaml | indent(8) }}

# Add alerting rules configuration if needed
# rule_files:
#   - "/etc/prometheus/rules/*.rules.yml"
